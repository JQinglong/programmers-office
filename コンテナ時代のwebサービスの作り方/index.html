<!doctype html><html class=no-js lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>コンテナ時代のWebサービスの作り方 - Programmers Office</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><meta property="og:title" content="コンテナ時代のWebサービスの作り方"><meta property="og:description" content="技術書典6で購入した本１冊目。 ガチで役に立つ本でした。 コンテナ時代のWebサービスの作り方 | 楽描商店 https://t.co/xFdOX3orNn 技術書典6で頒布した本をboothにて委託しております。ご活用ください。#booth_pm #技術書典 &mdash; とまと（nasum）技術書典え35楽"><meta property="og:type" content="article"><meta property="og:url" content="https://jqinglong.github.io/programmers-office/%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E6%99%82%E4%BB%A3%E3%81%AEweb%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9/"><meta property="article:published_time" content="2019-04-27T15:06:46+00:00"><meta property="article:modified_time" content="2019-04-27T15:06:46+00:00"><meta itemprop=name content="コンテナ時代のWebサービスの作り方"><meta itemprop=description content="技術書典6で購入した本１冊目。 ガチで役に立つ本でした。 コンテナ時代のWebサービスの作り方 | 楽描商店 https://t.co/xFdOX3orNn 技術書典6で頒布した本をboothにて委託しております。ご活用ください。#booth_pm #技術書典 &mdash; とまと（nasum）技術書典え35楽"><meta itemprop=datePublished content="2019-04-27T15:06:46+00:00"><meta itemprop=dateModified content="2019-04-27T15:06:46+00:00"><meta itemprop=wordCount content="1971"><meta itemprop=keywords content="AWS,Docker,"><meta name=twitter:card content="summary"><meta name=twitter:title content="コンテナ時代のWebサービスの作り方"><meta name=twitter:description content="技術書典6で購入した本１冊目。 ガチで役に立つ本でした。 コンテナ時代のWebサービスの作り方 | 楽描商店 https://t.co/xFdOX3orNn 技術書典6で頒布した本をboothにて委託しております。ご活用ください。#booth_pm #技術書典 &mdash; とまと（nasum）技術書典え35楽"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/programmers-office/css/style.css><link rel=stylesheet href=/programmers-office/css/custom.css><link rel="shortcut icon" href=/programmers-office/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/programmers-office/ title="Programmers Office" rel=home><div class="logo__item logo__text"><div class=logo__title>Programmers Office</div><div class=logo__tagline>中華圏に興味があるプログラマのラグジュアリーな生活</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>メニュー</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/><span class=menu__text>プログラミング</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/><span class=menu__text>ホーム</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E4%B8%AD%E5%9B%BD%E8%AA%9E/><span class=menu__text>中国語</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E4%B8%AD%E8%8F%AF%E4%B8%96%E7%95%8C/><span class=menu__text>中華世界</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E6%97%85%E8%A1%8C/><span class=menu__text>旅行</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E6%9B%B8%E7%B1%8D/><span class=menu__text>書籍</span></a></li><li class=menu__item><a class=menu__link href=/programmers-office/categories/%E9%96%A2%E5%BF%83%E3%81%94%E3%81%A8/><span class=menu__text>関心ごと</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>コンテナ時代のWebサービスの作り方</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>JayQ</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-04-27T15:06:46Z>2019-04-27</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/programmers-office/categories/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/ rel=category>プログラミング</a>, <a class=meta__link href=/programmers-office/categories/%E6%9B%B8%E7%B1%8D/ rel=category>書籍</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>目次</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#リージョン>リージョン</a></li><li><a href=#terraform>Terraform</a></li><li><a href=#rubyバージョン>rubyバージョン</a></li><li><a href=#awsリソースの作成>AWSリソースの作成</a></li><li><a href=#amazon-ecs>Amazon ECS</a></li><li><a href=#これ以降について>これ以降について</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>技術書典6で購入した本１冊目。<br>ガチで役に立つ本でした。</p><figure class="wp-block-embed-twitter wp-block-embed is-type-rich is-provider-twitter"><div class=wp-block-embed__wrapper><blockquote class=twitter-tweet data-width=500 data-dnt=true><p lang=ja dir=ltr>コンテナ時代のWebサービスの作り方 | 楽描商店 <a href=https://t.co/xFdOX3orNn>https://t.co/xFdOX3orNn</a><br>技術書典6で頒布した本をboothにて委託しております。ご活用ください。<a href="https://twitter.com/hashtag/booth_pm?src=hash&ref_src=twsrc%5Etfw">#booth_pm</a> <a href="https://twitter.com/hashtag/%E6%8A%80%E8%A1%93%E6%9B%B8%E5%85%B8?src=hash&ref_src=twsrc%5Etfw">#技術書典</a></p>&mdash; とまと（nasum）技術書典え35楽描帳 (@tomato360)
<a href="https://twitter.com/tomato360/status/1117434939748667393?ref_src=twsrc%5Etfw">April 14, 2019</a></blockquote></div></figure><p>とりあえず、76/103ページまでやってみました。ここまで行くと、ソースをコミットしたら自動的にサイトに反映される仕組みが動きます。<br>が、多少悪戦苦闘したところもありますので、その辺をメモ。</p><h2 id=リージョン>リージョン</h2><p>書籍では、東京リージョン（ap-northeast-1）を使うことになっていますが、元々オハイオを使っていたのでそちらのus-east-2を使うことにしてみました。<br>すると、</p><pre class=wp-block-code><code>The image id '[ami-785c491f]' does not exist</code></pre><p>となります。これはリージョンによって異なるので、ami-8b92b4eeに変更します。（参考）<a href=https://docs.docker.com/machine/drivers/aws/>https://docs.docker.com/machine/drivers/aws/</a></p><h2 id=terraform>Terraform</h2><p>Terraform初体験。インフラをコードで定義するとはこういうことなんだ。<br>しかし、これも簡単に進ませてはくれません。</p><pre class=wp-block-code><code>Error inspecting states in the "s3" backend:
    BucketRegionError: incorrect region, the bucket is not in 'us-east-2' region
	status code: 301, request id: , host id: </code></pre><p>今回一番ハマったかもしれないのはこのエラー。<br>例えば、</p><pre class=wp-block-code><code>aws s3 ls</code></pre><p>なんかを叩くと帰ってくるので、この接続でs3の所定のバケットが見えていないわけでもない。結局、フォルダ全体を一回消して、再度やり直したらOKという最悪パターンでした。</p><p>また、実際の発生順序は前後しますが、さらに進んでまたこのエラーが出るようになりましたが、書籍だと、aws_route_table.tf、aws_route_table_association.tfが、間違っているのでgithub（書籍に記載あり）のソースを見て記載しました。</p><h2 id=rubyバージョン>rubyバージョン</h2><p>元々のローカル環境がruby2.3.7だったのが悪いと思うのですが、最初にそれで進めてしまい、いざbuildが動くと</p><pre class=wp-block-code><code>You must use Bundler 2 or greater with this lockfile</code></pre><p>が出るようになってしまいました。<br>ちょこちょこやってみましたがダメなので、まずはローカル環境をアップすることにします。こちらなどを参考に。<br><a href=https://reasonable-code.com/ruby-on-rails-environment/>https://reasonable-code.com/ruby-on-rails-environment/</a></p><p>でこれも色々ありましたが、まず、アプリフォルダと同じ場所にある.ruby-versionの記載修正が必要ですね。<br>さらに、作成済みGemfileの記述を ruby ‘2.6.2’にし、Dockerfileは<br>FROM ruby:2.6.2とした上で、</p><pre class=wp-block-code><code>RUN \
    gem install bundler:2.0.1 && \
    bundle install && \
    rm -rf ~/.gem</code></pre><p>という形で、bundler:2.0.1の記述を追加。<br>ついでに、この状態で</p><pre class=wp-block-code><code>/usr/local/bundle/gems/execjs-2.7.0/lib/execjs/runtimes.rb:58:in `autodetect': Could not find a JavaScript runtime. See https://github.com/rails/execjs for a list of available runtimes. (ExecJS::RuntimeUnavailable)</code></pre><p>というエラーになっていたので、</p><pre class=wp-block-code><code>RUN apt-get update && \
    apt-get install -y nodejs</code></pre><p>も追加しました。</p><h2 id=awsリソースの作成>AWSリソースの作成</h2><p>まず書籍の誤記ですが、vpc/config.tfのkeyの記載は「terraform-sample/vpc/terraform.tfstate」ではなく、「sample/vpc/terraform.tfstate」が正しいです。<br>で、次はこんなエラー。</p><pre class=wp-block-code><code>* aws_security_group.instance (destroy): 1 error(s) occurred:

* aws_security_group.instance: DependencyViolation: resource sg-07ae3339a31044567 has a dependent object
	status code: 400, request id: 93ebbe83-5cf6-410e-a9a3-e651292a534b

Terraform does not automatically rollback in the face of errors.
Instead, your Terraform state file has been partially updated with
any resources that successfully completed. Please address the error
above and apply again to incrementally change your infrastructure.</code></pre><p>この時には、コンソールの方では、</p><pre class=wp-block-code><code>aws_security_group.instance: Still destroying... (ID: sg-07ae3339a31044567, 10m0s elapsed)</code></pre><p>というメッセージが出続けています。<br>要するに、このセキュリティグループを一旦削除して作りたいのに、削除ができない、ということのようで、確かに手動削除しようとしても削除できません。なので、このセキュリティグループを使用しているインスタンスを削除して、このセキュリティグループも削除してから、再度やり直すとOKでした。</p><h2 id=amazon-ecs>Amazon ECS</h2><p>さて、もう一息。ECSにクラスターが作成されたということで、この時よりは進んだ！<figure class="wp-block-embed is-type-rich is-provider-programmers-office"></p><div class=wp-block-embed__wrapper><blockquote class=wp-embedded-content data-secret=W9JSW4usc5><a href=https://www.programmers-office.ml/docker-%e7%92%b0%e5%a2%83%e3%82%92%e3%82%b9%e3%83%86%e3%83%bc%e3%82%b8%e3%83%b3%e3%82%b0%e7%92%b0%e5%a2%83%e3%81%b8%ef%bc%88docker-pull%e7%b7%a8%ef%bc%89part1/>Docker 環境をステージング環境へ（Docker pull編）part1</a></blockquote></div></figure><p>が、よくよく見ると、起動していない。サービスのページは下記のエラー。</p><pre class=wp-block-code><code>service rails-service is unable to consistently start tasks successfully. For more information, see the Troubleshooting section.
service rails-service was unable to place a task because no container instance met all of its requirements. Reason: No Container Instances were found in your cluster. For more information, see the Troubleshooting section.</code></pre><p>タスクのページは下記のエラー。</p><pre class=wp-block-code><code>状況の理由	CannotPullContainerError: Error response from daemon: manifest for 442268206491.dkr.ecr.us-east-2.amazonaws.com/sample-image:latest not found
コマンド	["bundle","exec","pumactl","start"]</code></pre><p>CircleCIを見ると下記のエラー。</p><pre class=wp-block-code><code>rails aborted!
Don't know how to build task 'assets:precomp' (See the list of available tasks with `rake --tasks`)</code></pre><p>precomp？？単に、書籍から貼り付けた記述の途中にスペースが入っていたということでした。これを修正して、ソースをコミットするとこにより、無事動いた状態ができあがりました。</p><p>ただ、ページを開くためにどうURLを記述したら良いかがわからなかった・・・</p><h2 id=これ以降について>これ以降について</h2><p>この後は、DBをMySQLにしたりするのですが、さらにお金がかかりそうなので、一旦ここまで。<br>かなり本格仕様の構成ができるので、うまくカスタマイズして使いたいところです。<br>そして、本書が良書であるのは間違いないところで、自分の目の付け所の良さに感動です（違うか！）。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/programmers-office/tags/aws/ rel=tag>AWS</a></li><li class=tags__item><a class="tags__link btn" href=/programmers-office/tags/docker/ rel=tag>Docker</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/programmers-office/glide%E3%81%AE%E5%91%B3%E3%82%8F%E3%81%84%E6%96%B9%E3%80%9C%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E6%B4%BB%E7%94%A8%E3%81%97%E3%82%88%E3%81%86/ rel=prev><span class=pager__subtitle>«&#8201;前の投稿</span><p class=pager__title>Glideの味わい方〜オープンデータを活用しよう</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/programmers-office/nuxt-js-%E3%81%A8-python-%E3%81%A6%E3%82%99%E3%81%A4%E3%81%8F%E3%82%8B%E3%81%AC%E3%82%8B%E3%81%95%E3%81%8F-ai-%E3%82%A2%E3%83%95%E3%82%9A%E3%83%AA%E9%96%8B%E7%99%BA%E5%85%A5%E9%96%80/ rel=next><span class=pager__subtitle>次の投稿&#8201;»</span><p class=pager__title>Nuxt.js と Python でつくるぬるさく AI アプリ開発入門</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/programmers-office/privacy/>プライバシーポリシー</a></div><div class=footer__copyright>&copy; 2020 JayQ.
<span class=footer__copyright-credits>このサイトは <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> と <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> テーマで生成されています。</span></div></div></footer></div><script async defer src=/programmers-office/js/menu.js></script><script src=/programmers-office/js/custom.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>